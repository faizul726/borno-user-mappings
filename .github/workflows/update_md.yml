name: Update README with Mappings Count

on:
  workflow_dispatch:
  push:
    paths:
      - mappings.txt

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Count lines in mappings.txt
        id: count_lines
        run: |
          COUNT=$(wc -l < mappings.txt)
          echo "COUNT=${COUNT}" >> $GITHUB_ENV

      - name: Get current date and time in Dhaka/Asia
        id: get_datetime
        run: |
          CURRENTDATETIME=$(TZ='Asia/Dhaka' date '+%B %d, %Y | %H:%M')
          echo "CURRENTDATETIME=${CURRENTDATETIME}" >> $GITHUB_ENV

      - name: Update README.md
        run: |
          # Read the current README.md
          if [ -f README.md ]; then
            CONTENT=$(cat README.md)
          else
            CONTENT=""
          fi

          # Create new line content with two spaces at the end
          NEW_LINE="**Number of mappings:** ${COUNT}  \n**Last updated:** ${CURRENTDATETIME}  "

          # Remove existing lines starting with • and replace them with the new line
          UPDATED_CONTENT=$(echo "$CONTENT" | sed -E '/^•/d')
          FINAL_CONTENT=$(echo "$UPDATED_CONTENT" | sed '$a\'"$NEW_LINE")

          # Write new content to README.md
          echo "$FINAL_CONTENT" > README.md

      - name: Commit and push changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: 'github-actions'
          author_email: 'actions@github.com'
          message: 'Update README with mappings count'
